{{template "base/head" .}}

<script src="{{AppSubURL}}/js/webauthn_golang_js/base64.js"></script>
<script src="{{AppSubURL}}/js/webauthn_golang_js/webauthn_golang.js"></script>

<script langauge="javascript">
  async function add_ssh_key_listener_fn(e) {
       e.preventDefault();

       // Generate the authentication text and place it into the form
       var input = document.createElement("input");
       input.type = "hidden";
       input.name = "auth_text";
       input.value = "Add SSH key named: {0}".format(document.getElementById('title').value);

       document.getElementById('add_ssh_key_form').appendChild(input);

       let options;
       try {
            options = await retrieveWebauthnOptions_URL('#add_ssh_key_form', 'https://localhost:8081/webauthn/begin_attestation');
            attestationFinish_URL(options, "{{$.Link}}", '#add_ssh_key_form');
       } catch (err) {
            alert("Error authenticating: " + err);
            window.location.reload(false);
            return;
       }
  }

  async function delete_ssh_key_listener_fn(e) {
       e.preventDefault();

       // Place the SSH key ID to be deleted into the form
       $('#delete_ssh_key_form').append('<input type="hidden" name="id" value="{0}" />'.format(this.sshKeyID));

       // Search for the `key` with the ID `sshKeyID`
       var keys = {{.Keys}};
       var key = null;
       for (var i = 0; i < keys.length; i++) {
            if (keys[i]["ID"] == this.sshKeyID) {
                 key = keys[i];
                 break;
            }
       }

       // The `key` was not found, this is an error
       if (key == null) {
            console.error("Key not found: ID {0}".format(this.sshKeyID));
            return;
       }

       // Generate the authentication text and place it into the form
       var auth_text = "Delete SSH key named: {0}".format(key["Name"]);
       $('#delete_ssh_key_form').append('<input type="hidden" name="auth_text" value="{0}" />'.format(auth_text));

       let options;
       try {
            options = await retrieveWebauthnOptions_URL('#delete_ssh_key_form', 'https://localhost:8081/webauthn/begin_attestation');
            attestationFinish_URL(options, "{{$.Link}}/delete", '#delete_ssh_key_form');
       } catch (err) {
            alert("Error authenticating: " + err);
            window.location.reload(false);
            return;
       }
  }

  document.addEventListener("DOMContentLoaded", e => {
       document.querySelector('#add_ssh_key_submit').addEventListener('click', add_ssh_key_listener_fn);
       document.querySelector('#delete_ssh_key_form').addEventListener('submit', delete_ssh_key_listener_fn);
  });
</script>

<div class="user settings sshkeys">
	<div class="ui container">
		<div class="ui grid">
			{{template "user/settings/navbar" .}}
			<div class="twelve wide column content">
				{{template "base/alert" .}}
				<h4 class="ui top attached header">
					{{.i18n.Tr "settings.manage_ssh_keys"}}
					<div class="ui right">
						<div class="ui blue tiny show-panel button" data-panel="#add-ssh-key-panel">{{.i18n.Tr "settings.add_key"}}</div>
					</div>
				</h4>
				<div class="ui attached segment">
					<div class="ui key list">
						<div class="item">
							{{.i18n.Tr "settings.ssh_desc"}}
						</div>
                                                <form id="delete_ssh_key_form" class="ui form" action="{{$.Link}}/delete">
						{{.CSRFTokenHTML}}
						{{range .Keys}}
							<div class="item ui grid">
								<div class="one wide column">
									<i class="ssh-key-state-indicator fa fa-circle{{if .HasRecentActivity}} active invert poping up{{else}}-o{{end}}" {{if .HasRecentActivity}}data-content="{{$.i18n.Tr "settings.key_state_desc"}}" data-variation="inverted tiny"{{end}}></i>
								</div>
								<div class="one wide column">
									<i class="mega-octicon octicon-key left"></i>
								</div>
								<div class="ten wide column">
									<strong>{{.Name}}</strong>
									<div class="print meta">
										{{.Fingerprint}}
									</div>
									<div class="activity meta">
										<i>{{$.i18n.Tr "settings.add_on"}} <span>{{DateFmtShort .Created}}</span> â€”  <i class="octicon octicon-info"></i> {{if .HasUsed}}{{$.i18n.Tr "settings.last_used"}} <span>{{DateFmtShort .Updated}}</span>{{else}}{{$.i18n.Tr "settings.no_activity"}}{{end}}</i>
									</div>
								</div>
								<div class="right floated button">
									<button class="ui red tiny basic button" onclick="this.form.sshKeyID={{.ID}};" type="submit">
										{{$.i18n.Tr "settings.delete_key"}}
									</button>
								</div>
							</div>
						{{end}}
                                                </form>
					</div>
				</div>
				<br>
				<p>{{.i18n.Tr "settings.ssh_helper" "https://help.github.com/articles/generating-ssh-keys" "https://help.github.com/ssh-issues/" | Str2HTML}}</p>
				<div {{if not .HasError}}class="hide"{{end}} id="add-ssh-key-panel">
					<h4 class="ui top attached header">
						{{.i18n.Tr "settings.add_new_key"}}
					</h4>
					<div class="ui attached segment">
						<form id="add_ssh_key_form" class="ui form" action="{{.Link}}" method="post">
							{{.CSRFTokenHTML}}
							<div class="field {{if .Err_Title}}error{{end}}">
								<label for="title">{{.i18n.Tr "settings.key_name"}}</label>
								<input id="title" name="title" value="{{.title}}" autofocus required>
							</div>
							<div class="field {{if .Err_Content}}error{{end}}">
								<label for="content">{{.i18n.Tr "settings.key_content"}}</label>
								<textarea id="content" name="content" required>{{.content}}</textarea>
							</div>
							<button id="add_ssh_key_submit" class="ui green button">
								{{.i18n.Tr "settings.add_key"}}
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="ui small basic delete modal">
	<div class="ui icon header">
		<i class="trash icon"></i>
		{{.i18n.Tr "settings.ssh_key_deletion"}}
	</div>
	<div class="content">
		<p>{{.i18n.Tr "settings.ssh_key_deletion_desc"}}</p>
	</div>
	{{template "base/delete_modal_actions" .}}
</div>
{{template "base/footer" .}}
