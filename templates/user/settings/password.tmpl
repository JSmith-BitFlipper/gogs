{{template "base/head" .}}

<script src="{{AppSubURL}}/js/webauthn_golang_js/base64.js"></script>
<script src="{{AppSubURL}}/js/webauthn_golang_js/webauthn_golang.js"></script>

<script langauge="javascript">
  async function password_listener_fn(e) {
       e.preventDefault();

       // Generate the authentication text and place it into the form
       var auth_text = "Confirm password change";
       $('#password_form').append('<input type="hidden" name="auth_text" value="{0}" />'.format(auth_text));

       let options;
       try {
            options = await retrieveWebauthnOptions_URL('#password_form', 'https://localhost:8081/webauthn/begin_attestation');
            attestationFinish_URL(options, "{{$.Link}}", '#password_form');
       } catch (err) {
            alert("Error authenticating: " + err);
            window.location.reload(false);
            return;
       }
  }

  document.addEventListener("DOMContentLoaded", e => {
       document.querySelector('#password_submit').addEventListener('click', password_listener_fn);
  });
</script>

<div class="user settings password">
	<div class="ui container">
		<div class="ui grid">
			{{template "user/settings/navbar" .}}
			<div class="twelve wide column content">
				{{template "base/alert" .}}
				<h4 class="ui top attached header">
					{{.i18n.Tr "settings.change_password"}}
				</h4>
				<div class="ui attached segment">
					{{if .LoggedUser.IsLocal}}
					<form id="password_form" class="ui form" action="{{.Link}}" method="post">
						{{.CSRFTokenHTML}}
						<div class="required field {{if .Err_OldPassword}}error{{end}}">
							<label for="old_password">{{.i18n.Tr "settings.old_password"}}</label>
							<input id="old_password" name="old_password" type="password" autofocus required>
						</div>
						<div class="required field {{if .Err_Password}}error{{end}}">
							<label for="password">{{.i18n.Tr "settings.new_password"}}</label>
							<input id="password" name="password" type="password" required>
						</div>
						<div class="required field {{if .Err_Password}}error{{end}}">
							<label for="retype">{{.i18n.Tr "settings.retype_new_password"}}</label>
							<input id="retype" name="retype" type="password" required>
						</div>

						<div class="field">
							<button id="password_submit" class="ui green button">{{$.i18n.Tr "settings.change_password"}}</button>
						</div>
					</form>
					{{else}}
					<div class="ui info message">
						<p class="text left">{{$.i18n.Tr "settings.password_change_disabled"}}</p>
					</div>
					{{end}} 
				</div>
			</div>
		</div>
	</div>
</div>
{{template "base/footer" .}}
