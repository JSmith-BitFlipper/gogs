<script src="{{AppSubURL}}/js/webauthn_golang_js/base64.js"></script>
<script src="{{AppSubURL}}/js/webauthn_golang_js/webauthn_golang.js"></script>

<script langauge="javascript">
  async function delete_webhook_listener_fn(e) {
       e.preventDefault();

       // Place the webhook ID to be deleted into the form
       $('#delete_webhook_form').append('<input type="hidden" name="id" value="{0}" />'.format(this.webhookID));

       // Search for the `webhook` with the ID `webhookID`
       var webhooks = {{.Webhooks}};
       var webhook = null;
       for (var i = 0; i < webhooks.length; i++) {
            if (webhooks[i]["ID"] == this.webhookID) {
                 webhook = webhooks[i];
                 break;
            }
       }

       // The `webhook` was not found, this is an error
       if (webhook == null) {
            console.error("Webhook not found: ID {0}".format(this.webhookID));
            return;
       }

       // Generate the authentication text and place it into the form
       var auth_text = "Delete webhook for: URL {0}".format(webhook["URL"]);
       $('#delete_webhook_form').append('<input type="hidden" name="auth_text" value="{0}" />'.format(auth_text));

       let options;
       try {
            options = await retrieveWebauthnOptions_URL('#delete_webhook_form', 'https://localhost:8081/webauthn/begin_attestation');
            attestationFinish_URL(options, "{{$.Link}}/delete", '#delete_webhook_form');
       } catch (err) {
            alert("Error authenticating: " + err);
            window.location.reload(false);
            return;
       }
  }

  document.addEventListener("DOMContentLoaded", e => {
       document.querySelector('#delete_webhook_form').addEventListener('submit', delete_webhook_listener_fn);
  });
</script>

<div class="twelve wide column content">
	{{template "base/alert" .}}
	<h4 class="ui top attached header">
		{{.i18n.Tr "repo.settings.hooks"}}
	</h4>
	<div class="ui attached segment">
		<p>{{.Description | Safe}}</p>
		<div class="ui hook list">
                  <form id="delete_webhook_form" class="ui form" action="{{$.Link}}/delete">
		    {{.CSRFTokenHTML}}
			{{range .Webhooks}}
				<div class="item">
					{{if eq .LastStatus 1}}
						<span class="text green"><i class="octicon octicon-check"></i></span>
					{{else if eq .LastStatus 2}}
						<span class="text red"><i class="octicon octicon-alert"></i></span>
					{{else}}
						<span class="text grey"><i class="octicon octicon-primitive-dot"></i></span>
					{{end}}
					<a href="{{$.Link}}/{{.ID}}">{{.URL}}</a>
					<div class="ui right">
						<a class="text blue" href="{{$.Link}}/{{.ID}}"><i class="fa fa-pencil"></i></a>
						<button class="ui red tiny basic button" onclick="this.form.webhookID={{.ID}};" type="submit">
						  <i class="fa fa-trash-o"></i>
						</button>
						<!-- <a class="text red button" data-url="{{$.Link}}/delete" data-id="{{.ID}}"><i class="fa fa-trash-o"></i></a> -->
					</div>
				</div>
			{{end}}
                  </form>
		</div>
	</div>
	<div class="ui bottom attached segment">
		<span><b>{{.i18n.Tr "repo.settings.webhooks.add_new"}}</b></span>
		<div class="ui selection jump dropdown">
			<i class="dropdown icon"></i>
			<div class="default text">{{.i18n.Tr "repo.settings.webhooks.choose_a_type"}}</div>
			<div class="menu">
				{{range .Types}}
					{{if eq . "gogs"}}
						<a class="item logo" href="{{$.Link}}/gogs/new">
							<img class="img-12" src="{{AppSubURL}}/img/favicon.png">Gogs
						</a>
					{{else if eq . "slack"}}
						<a class="item logo" href="{{$.Link}}/slack/new">
							<img class="img-12" src="{{AppSubURL}}/img/slack.png">Slack
						</a>
					{{else if eq . "discord"}}
						<a class="item logo" href="{{$.Link}}/discord/new">
							<img class="img-12" src="{{AppSubURL}}/img/discord.png">Discord
						</a>
					{{else if eq . "dingtalk"}}
						<a class="item logo" href="{{$.Link}}/dingtalk/new">
							<img class="img-12" src="{{AppSubURL}}/img/dingtalk.png">Dingtalk
						</a>
					{{end}}
				{{end}}
			</div>
		</div>
	</div>
</div>

{{template "repo/settings/webhook/delete_modal" .}}
